Pappu â€” here is a complete, production-quality middleware documentation for your Email Verification SaaS backend.
This can be used for:
âœ” Developer onboarding
âœ” GitHub README
âœ” System architecture documentation
âœ” Internal engineering handover
âœ” API team reference


---

ğŸ“˜ EMAIL VERIFICATION SAAS â€“ MIDDLEWARE DOCUMENTATION

This document explains every middleware, its purpose, order of execution, and how it integrates with the rest of the backend.

This matches your actual project structure:

backend/app/middleware/
    â”œâ”€â”€ cors.py
    â”œâ”€â”€ request_logger.py
    â”œâ”€â”€ audit_middleware.py
    â”œâ”€â”€ api_key_guard.py
    â”œâ”€â”€ team_context.py
    â”œâ”€â”€ team_acl.py
    â”œâ”€â”€ rate_limiter.py


---

ğŸ”· 1. Middleware Execution Order (Critical)

Middleware must run in this exact sequence to ensure correct functionality:

1ï¸âƒ£ CORS
2ï¸âƒ£ RequestLoggerMiddleware
3ï¸âƒ£ AuditMiddleware
4ï¸âƒ£ APIKeyGuardMiddleware
5ï¸âƒ£ TeamContextMiddleware
6ï¸âƒ£ TeamACL
7ï¸âƒ£ RateLimiterMiddleware

This order provides:

Max logging visibility

Stable security & permissions

Proper team resolution

Correct API-key enforcement

Accurate rate limiting



---

ğŸ“— 2. CORS Middleware (cors.py)

ğŸ“Œ Purpose

Enables Cross-Origin Resource Sharing for frontend â†’ backend communication.

âœ” Responsibilities

Allow requests from frontend domain

Handle preflight (OPTIONS)

Expose custom headers (X-Request-Id)

Allow Authorization & API Key headers

Prevent CORS misconfiguration


ğŸ”§ Configured via ENV

CORS_ALLOW_ORIGINS="http://localhost:3000,https://yourdomain.com"

âš  Must be FIRST middleware


---

ğŸ“™ 3. Request Logger (request_logger.py)

ğŸ“Œ Purpose

Log every HTTP request with structured details.

âœ” Logs:

HTTP method

URL path

Query string

Status code

Duration (ms)

Client IP

Request ID (trace ID)

User ID (if known)

Team ID

API key ID

Safely redacts email/IP PII from logs


âœ” Benefits:

Full request tracing

Debugging

Performance profiling

Observability


âœ” Never logs sensitive data like body fields.


---

ğŸ“• 4. Audit Middleware (audit_middleware.py)

ğŸ“Œ Purpose

Store important request metadata into the audit_log table.

âœ” What it records:

Timestamp

Path

HTTP method

Status code

Duration

User ID

Team ID

API key ID

Error messages

IP, User-Agent, Referrer


âœ” Where stored?

audit_log database table.

âœ” How?

Runs after request logger

Uses asyncio.to_thread for async-safe DB writing

Fail-safe (never breaks API even if DB unavailable)


ğŸ”¥ Useful for:

Billing

Fraud detection

User activity logs

Admin analytics

Compliance (GDPR, DPDP, SOC2)



---

ğŸ“˜ 5. API Key Guard (api_key_guard.py)

ğŸ“Œ Purpose

Authenticate API key requests and attach identity to the request.

âœ” Reads from:

X-API-Key header

âœ” Responsibilities:

Validate API key

Attach fields to request:

request.state.api_key

request.state.api_key_row

request.state.api_user_id


Enforce daily/monthly usage quota

Increment usage count

Log usage activity


âœ” Failure behavior:

Invalid key â†’ 401

Blocked/expired key â†’ 403

Usage exceeded â†’ 429


âœ” Required by:

Single email verify endpoint

Bulk verify

Extractor API

Webhook API



---

ğŸ“— 6. Team Context Middleware (team_context.py)

ğŸ“Œ Purpose

Determine which team the request belongs to.

âœ” Determines team from:

Priority:

1. API key â†’ team binding


2. X-Team-Id header


3. ?team_id= URL param


4. Default team of logged-in user


5. Fallback (no team)



âœ” Sets:

request.state.team

request.state.team_id


âœ” Validates:

Team exists

User is allowed to request that team

API key is valid for that team


âœ” Required for:

Billing

Usage logging

Credits

Subscriptions

Team invoices

Admin team settings



---

ğŸ“™ 7. Team ACL Middleware (team_acl.py)

ğŸ“Œ Purpose

Load permissions & roles for the team.

âœ” Reads from:

request.state.team_id

request.state.user or request.state.api_user_id


âœ” Determines:

Role: owner, admin, member, viewer, billing

Permission matrix:

can_manage_billing

can_view_usage

can_invite

can_delete_team

can_manage_api_keys



âœ” Outputs:

request.state.team_role

request.state.team_perms


âœ” FAILS only if:

User or API key is not a member of the selected team.


---

ğŸ“˜ 8. Rate Limiter (rate_limiter.py)

ğŸ“Œ Purpose

Prevent abuse and protect infrastructure using Redis-based throttling.

âœ” Applies limits in this order:

1. API key


2. Team


3. User


4. IP (fallback)



âœ” Default limits:

120 requests/min

10,000 requests/day

Optional overrides via env


âœ” Uses:

Redis INCR + EXPIRE windows

Fail-open design:
â†’ If Redis fails, API continues (no downtime)


âœ” Prevents:

API abuse

Denial-of-service

Bulk bot traffic

Free-tier abuse



---

ğŸ§© 9. Middleware Interaction Diagram

Incoming Request
      |
      v
[CORS]
      |
      v
[Request Logger]
      |
      v
[Audit Middleware]
      |
      v
[API Key Guard]
      |
      v
[Team Context]
      |
      v
[Team ACL]
      |
      v
[Rate Limiter]
      |
      v
----- ROUTER / ENDPOINT -----
      |
      v
   Response


---

ğŸ“¦ 10. Summary

Your middleware stack now provides:

Middleware	Purpose	Critical For

CORS	Frontend access	Browser requests
Request Logger	Traceability	Debugging, monitoring
Audit	DB logs	Billing, analytics, compliance
API Key Guard	Security & quotas	API endpoints
Team Context	Multi-team support	Billing, credits, usage
Team ACL	Authorization	Team roles & privileges
Rate Limiter	Protection	Abuse prevention


This is a full enterprise-grade middleware architecture, equivalent to:

ZeroBounce

NeverBounce

Clearout

Kickbox

Hunter.io Enterprise



---

ğŸ¯ What do you want next?

Choose one:

1ï¸âƒ£ Router Documentation

(Explain every router in /api/v1)

2ï¸âƒ£ Services Layer Documentation

(Explain verification pipeline, domain backoff, smtp probe, etc.)

3ï¸âƒ£ Workers & Queue Documentation

(Celery architecture, tasks flow)

4ï¸âƒ£ Database Schema Documentation

(Relational diagrams + table purpose)

5ï¸âƒ£ Full Backend Architecture PDF (Iâ€™ll generate)

Tell me which one: 1 / 2 / 3 / 4 / 5
